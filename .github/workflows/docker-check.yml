name: Docker Build Check

# Uruchamiaj tylko na Twoich branchach
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-docker-images:
    # WAŻNE: Używamy Twojej maszyny wirtualnej (runnera)
    runs-on: self-hosted
    timeout-minutes: 20
    env:
      DOCKER_HOST: unix:///run/docker.sock
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Disk usage (before)
      run: |
        echo "=== Disk usage before ==="
        df -h || true
        echo "=== Docker disk usage before ==="
        sudo -n docker system df || true

    - name: Pre-clean Docker space
      run: |
        echo "Pruning unused Docker data before build..."
        sudo -n docker container prune -f || true
        sudo -n docker image prune -af || true
        sudo -n docker builder prune -af || true

    - name: Docker diagnostics
      run: |
        echo "USER: $(whoami)"
        echo "ID: $(id)"
        docker --version || true
        groups || true
        echo "Docker socket perms:"
        ls -l /var/run/docker.sock || ls -l /run/docker.sock || true
        sudo -n docker info || true

    - name: Verify Docker connectivity
      run: |
        echo "Checking docker ps via $DOCKER_HOST"
        sudo -n docker ps

    - name: Build Backend Image
      # Buduje backend używając Twojego pliku DockerfileBuild
      run: sudo -n docker build -f DockerfileBuild -t demo-backend:test .

    - name: Build Frontend Image
      # Buduje frontend używając Twojego pliku DockerfileFrontend
      run: sudo -n docker build -f DockerfileFrontend -t demo-frontend:test .

    - name: Post-clean Docker space
      if: always()
      run: |
        echo "Removing job images and pruning..."
        sudo -n docker image rm -f demo-backend:test demo-frontend:test || true
        sudo -n docker container prune -f || true
        sudo -n docker image prune -af || true
        sudo -n docker builder prune -af || true

    - name: Disk usage (after)
      if: always()
      run: |
        echo "=== Disk usage after ==="
        df -h || true
        echo "=== Docker disk usage after ==="
        sudo -n docker system df || true